{"ast":null,"code":"'use strict';\n\n(function () {\n  var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;\n  enterModule && enterModule(module);\n})();\n\nvar __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {\n  return a;\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _values = require('babel-runtime/core-js/object/values');\n\nvar _values2 = _interopRequireDefault(_values);\n\nvar _regenerator = require('babel-runtime/regenerator');\n\nvar _regenerator2 = _interopRequireDefault(_regenerator);\n\nvar _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');\n\nvar _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);\n\nvar _extends2 = require('babel-runtime/helpers/extends');\n\nvar _extends3 = _interopRequireDefault(_extends2);\n\nexports.setChosenAddress = setChosenAddress;\nexports.obtainPathComponentsFromDerivationPath = obtainPathComponentsFromDerivationPath;\nexports.default = createLedgerSubprovider;\n\nvar _hwAppEth = require('@ledgerhq/hw-app-eth');\n\nvar _hwAppEth2 = _interopRequireDefault(_hwAppEth);\n\nvar _hookedWallet = require('web3-provider-engine/dist/es5/subproviders/hooked-wallet');\n\nvar _hookedWallet2 = _interopRequireDefault(_hookedWallet);\n\nvar _ethereumjsTx = require('ethereumjs-tx');\n\nvar _ethereumjsTx2 = _interopRequireDefault(_ethereumjsTx);\n\nvar _addressGenerator = require('./address-generator');\n\nvar _addressGenerator2 = _interopRequireDefault(_addressGenerator);\n\nfunction _interopRequireDefault(obj) {\n  return obj && obj.__esModule ? obj : {\n    default: obj\n  };\n}\n/* eslint-disable */\n\n\nvar allowedHdPaths = [\"44'/1'\", \"44'/60'\", \"44'/61'\"];\nvar chosenAddress = void 0;\n\nfunction setChosenAddress(address) {\n  chosenAddress = address;\n}\n\nfunction stripHexPrefix(str) {\n  if (typeof str !== 'string') return str;\n  return str.replace(/^0x/, '');\n}\n\nvar ledgerLiveRegex = /^(44'\\/(?:1|60|61)'\\/)(\\d+)('?)$/;\n\nfunction makeError(msg, id) {\n  var err = new Error(msg); // $FlowFixMe\n\n  err.id = id;\n  return err;\n}\n\nfunction obtainPathComponentsFromDerivationPath(derivationPath) {\n  // check if derivation path follows 44'/60'/x'/n pattern\n  var regExp = /^(44'\\/(?:1|60|61)'\\/\\d+'?\\/(?:\\d+'?\\/)?)(\\d+)$/;\n  var matchResult = regExp.exec(derivationPath);\n\n  if (matchResult === null) {\n    throw makeError('invalid derivation path', 'InvalidDerivationPath');\n  }\n\n  return {\n    basePath: matchResult[1],\n    index: parseInt(matchResult[2], 10)\n  };\n}\n/**\n */\n\n\nvar defaultOptions = {\n  networkId: 1,\n  // mainnet\n  path: \"44'/60'/0'/0\",\n  askConfirm: false,\n  accountsLength: 1,\n  accountsOffset: 0\n};\n/**\n * Create a HookedWalletSubprovider for Ledger devices.\n * @param getTransport gets lazily called each time the device is needed. It is a function that returns a Transport instance. You can typically give `()=>TransportU2F.create()`\n * @example\nimport Web3 from \"web3\";\nimport createLedgerSubprovider from \"@ledgerhq/web3-subprovider\";\nimport TransportU2F from \"@ledgerhq/hw-transport-u2f\";\nimport ProviderEngine from \"web3-provider-engine\";\nimport RpcSubprovider from \"web3-provider-engine/subproviders/rpc\";\nconst engine = new ProviderEngine();\nconst getTransport = () => TransportU2F.create();\nconst ledger = createLedgerSubprovider(getTransport, {\n  accountsLength: 5\n});\nengine.addProvider(ledger);\nengine.addProvider(new RpcSubprovider({ rpcUrl }));\nengine.start();\nconst web3 = new Web3(engine);\n */\n\nfunction createLedgerSubprovider(getTransport, options) {\n  var _getAccounts = function () {\n    var _ref = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee() {\n      var _this = this;\n\n      var transport, eth, addresses, _loop, i, pathComponents, addressGenerator, _path, address;\n\n      return _regenerator2.default.wrap(function _callee$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return getTransport();\n\n            case 2:\n              transport = _context2.sent;\n              _context2.prev = 3;\n              eth = new _hwAppEth2.default(transport);\n              addresses = {};\n\n              if (!path.match(ledgerLiveRegex)) {\n                _context2.next = 16;\n                break;\n              }\n\n              _loop = /*#__PURE__*/_regenerator2.default.mark(function _loop(i) {\n                var newPath, _ref2, address;\n\n                return _regenerator2.default.wrap(function _loop$(_context) {\n                  while (1) {\n                    switch (_context.prev = _context.next) {\n                      case 0:\n                        newPath = path.replace(ledgerLiveRegex, function (_, g1, g2, g3) {\n                          return g1 + String(parseInt(g2) + accountsOffset + i) + g3;\n                        }) + '/0/0';\n                        _context.next = 3;\n                        return eth.getAddress(newPath, askConfirm, true);\n\n                      case 3:\n                        _ref2 = _context.sent;\n                        address = _ref2.address;\n                        addresses[newPath] = address;\n                        addressToPathMap[address.toLowerCase()] = newPath;\n\n                      case 7:\n                      case 'end':\n                        return _context.stop();\n                    }\n                  }\n                }, _loop, _this);\n              });\n              i = 0;\n\n            case 9:\n              if (!(i < accountsLength)) {\n                _context2.next = 14;\n                break;\n              }\n\n              return _context2.delegateYield(_loop(i), 't0', 11);\n\n            case 11:\n              i++;\n              _context2.next = 9;\n              break;\n\n            case 14:\n              _context2.next = 25;\n              break;\n\n            case 16:\n              pathComponents = obtainPathComponentsFromDerivationPath(path);\n              _context2.t1 = _addressGenerator2.default;\n              _context2.next = 20;\n              return eth.getAddress(pathComponents.basePath, askConfirm, true);\n\n            case 20:\n              _context2.t2 = _context2.sent;\n              _context2.next = 23;\n              return new _context2.t1(_context2.t2);\n\n            case 23:\n              addressGenerator = _context2.sent;\n\n              for (i = accountsOffset; i < accountsOffset + accountsLength; i++) {\n                _path = pathComponents.basePath + (pathComponents.index + i).toString();\n                address = addressGenerator.getAddressString(i);\n                addresses[_path] = address;\n                addressToPathMap[address.toLowerCase()] = _path;\n              }\n\n            case 25:\n              return _context2.abrupt('return', addresses);\n\n            case 26:\n              _context2.prev = 26;\n              transport.close();\n              return _context2.finish(26);\n\n            case 29:\n            case 'end':\n              return _context2.stop();\n          }\n        }\n      }, _callee, this, [[3,, 26, 29]]);\n    }));\n\n    return function _getAccounts() {\n      return _ref.apply(this, arguments);\n    };\n  }();\n\n  var _signPersonalMessage = function () {\n    var _ref3 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee2(msgData) {\n      var path, transport, eth, result, v, vHex;\n      return _regenerator2.default.wrap(function _callee2$(_context3) {\n        while (1) {\n          switch (_context3.prev = _context3.next) {\n            case 0:\n              if (chosenAddress) {\n                msgData.from = chosenAddress;\n              }\n\n              path = addressToPathMap[msgData.from.toLowerCase()];\n\n              if (path) {\n                _context3.next = 4;\n                break;\n              }\n\n              throw new Error('address unknown \\'' + msgData.from + '\\'');\n\n            case 4:\n              _context3.next = 6;\n              return getTransport();\n\n            case 6:\n              transport = _context3.sent;\n              _context3.prev = 7;\n              eth = new _hwAppEth2.default(transport);\n              _context3.next = 11;\n              return eth.signPersonalMessage(path, stripHexPrefix(msgData.data));\n\n            case 11:\n              result = _context3.sent;\n              v = parseInt(result.v, 10) - 27;\n              vHex = v.toString(16);\n\n              if (vHex.length < 2) {\n                vHex = '0' + v;\n              }\n\n              return _context3.abrupt('return', '0x' + result.r + result.s + vHex);\n\n            case 16:\n              _context3.prev = 16;\n              transport.close();\n              return _context3.finish(16);\n\n            case 19:\n            case 'end':\n              return _context3.stop();\n          }\n        }\n      }, _callee2, this, [[7,, 16, 19]]);\n    }));\n\n    return function _signPersonalMessage(_x) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  var _signTransaction = function () {\n    var _ref4 = (0, _asyncToGenerator3.default)( /*#__PURE__*/_regenerator2.default.mark(function _callee3(txData) {\n      var path, transport, eth, tx, result, signedChainId, validChainId;\n      return _regenerator2.default.wrap(function _callee3$(_context4) {\n        while (1) {\n          switch (_context4.prev = _context4.next) {\n            case 0:\n              if (chosenAddress) {\n                txData.from = chosenAddress;\n              }\n\n              path = addressToPathMap[txData.from.toLowerCase()];\n\n              if (path) {\n                _context4.next = 4;\n                break;\n              }\n\n              throw new Error('address unknown \\'' + txData.from + '\\'');\n\n            case 4:\n              _context4.next = 6;\n              return getTransport();\n\n            case 6:\n              transport = _context4.sent;\n              _context4.prev = 7;\n              eth = new _hwAppEth2.default(transport);\n              tx = new _ethereumjsTx2.default(txData); // Set the EIP155 bits\n\n              tx.raw[6] = Buffer.from([networkId]); // v\n\n              tx.raw[7] = Buffer.from([]); // r\n\n              tx.raw[8] = Buffer.from([]); // s\n              // Pass hex-rlp to ledger for signing\n\n              _context4.next = 15;\n              return eth.signTransaction(path, tx.serialize().toString('hex'));\n\n            case 15:\n              result = _context4.sent; // Store signature in transaction\n\n              tx.v = Buffer.from(result.v, 'hex');\n              tx.r = Buffer.from(result.r, 'hex');\n              tx.s = Buffer.from(result.s, 'hex'); // EIP155: v should be chain_id * 2 + {35, 36}\n\n              signedChainId = Math.floor((tx.v[0] - 35) / 2);\n              validChainId = networkId & 0xff; // FIXME this is to fixed a current workaround that app don't support > 0xff\n\n              if (!(signedChainId !== validChainId)) {\n                _context4.next = 23;\n                break;\n              }\n\n              throw makeError('Invalid networkId signature returned. Expected: ' + networkId + ', Got: ' + signedChainId, 'InvalidNetworkId');\n\n            case 23:\n              return _context4.abrupt('return', '0x' + tx.serialize().toString('hex'));\n\n            case 24:\n              _context4.prev = 24;\n              transport.close();\n              return _context4.finish(24);\n\n            case 27:\n            case 'end':\n              return _context4.stop();\n          }\n        }\n      }, _callee3, this, [[7,, 24, 27]]);\n    }));\n\n    return function _signTransaction(_x2) {\n      return _ref4.apply(this, arguments);\n    };\n  }();\n\n  var _defaultOptions$optio = (0, _extends3.default)({}, defaultOptions, options),\n      networkId = _defaultOptions$optio.networkId,\n      path = _defaultOptions$optio.path,\n      askConfirm = _defaultOptions$optio.askConfirm,\n      accountsLength = _defaultOptions$optio.accountsLength,\n      accountsOffset = _defaultOptions$optio.accountsOffset;\n\n  if (!allowedHdPaths.some(function (hdPref) {\n    return path.startsWith(hdPref);\n  })) {\n    throw makeError('Ledger derivation path allowed are ' + allowedHdPaths.join(', ') + '. ' + path + ' is not supported', 'InvalidDerivationPath');\n  }\n\n  var addressToPathMap = {};\n\n  if (options.promisify) {\n    return new _hookedWallet2.default({\n      getAccounts: _getAccounts,\n      signPersonalMessage: _signPersonalMessage,\n      signTransaction: _signTransaction\n    });\n  }\n\n  return new _hookedWallet2.default({\n    getAccounts: function getAccounts(callback) {\n      return _getAccounts().then(function (res) {\n        return callback(null, (0, _values2.default)(res));\n      }).catch(function (err) {\n        return callback(err, null);\n      });\n    },\n    signPersonalMessage: function signPersonalMessage(txData, callback) {\n      return _signPersonalMessage(txData).then(function (res) {\n        return callback(null, res);\n      }).catch(function (err) {\n        return callback(err, null);\n      });\n    },\n    signTransaction: function signTransaction(txData, callback) {\n      _signTransaction(txData).then(function (res) {\n        return callback(null, res);\n      }).catch(function (err) {\n        return callback(err, null);\n      });\n    }\n  });\n}\n\n;\n\n(function () {\n  var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;\n\n  if (!reactHotLoader) {\n    return;\n  }\n\n  reactHotLoader.register(_values2, \"_values2\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_regenerator2, \"_regenerator2\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_asyncToGenerator3, \"_asyncToGenerator3\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_extends3, \"_extends3\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_hwAppEth2, \"_hwAppEth2\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_hookedWallet2, \"_hookedWallet2\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_ethereumjsTx2, \"_ethereumjsTx2\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_addressGenerator2, \"_addressGenerator2\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(_interopRequireDefault, \"_interopRequireDefault\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(allowedHdPaths, \"allowedHdPaths\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(chosenAddress, \"chosenAddress\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(setChosenAddress, \"setChosenAddress\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(stripHexPrefix, \"stripHexPrefix\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(ledgerLiveRegex, \"ledgerLiveRegex\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(makeError, \"makeError\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(obtainPathComponentsFromDerivationPath, \"obtainPathComponentsFromDerivationPath\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(defaultOptions, \"defaultOptions\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n  reactHotLoader.register(createLedgerSubprovider, \"createLedgerSubprovider\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/@makerdao/dai-plugin-ledger-web/vendor/ledger-subprovider.js\");\n})();\n\n;\n\n(function () {\n  var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;\n  leaveModule && leaveModule(module);\n})();","map":null,"metadata":{},"sourceType":"script"}
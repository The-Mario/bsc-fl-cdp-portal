{"ast":null,"code":"import _regeneratorRuntime from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\n\nvar _this = this,\n    _jsxFileName = \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/components/Sidebars/Payback.js\";\n\n(function () {\n  var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;\n  enterModule && enterModule(module);\n})();\n\nvar __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {\n  return a;\n};\n\nimport React from 'react';\nimport { USDFL } from '../../libs/dai-plugin-mcd/src/index.js';\nimport { Text, Input, Grid, Button } from '@makerdao/ui-components-core';\nimport debug from 'debug';\nimport { getColor } from '../../styles/theme';\nimport { formatCollateralizationRatio } from 'utils/ui';\nimport useMaker from 'hooks/useMaker';\nimport useProxy from 'hooks/useProxy';\nimport useTokenAllowance from 'hooks/useTokenAllowance';\nimport useWalletBalances from 'hooks/useWalletBalances';\nimport useValidatedInput from 'hooks/useValidatedInput';\nimport useLanguage from 'hooks/useLanguage';\nimport useAnalytics from 'hooks/useAnalytics';\nimport { formatter } from '../../utils/ui';\nimport { subtract, greaterThan, equalTo, minimum } from '../../utils/bignumber';\nimport Info from './shared/Info';\nimport InfoContainer from './shared/InfoContainer';\nimport ProxyAllowanceToggle from 'components/ProxyAllowanceToggle';\nimport SetMax from 'components/SetMax';\nimport { decimalRules } from '../../styles/constants';\nvar short = decimalRules.short;\nvar log = debug('maker:Sidebars/Payback');\n\nvar Payback = function Payback(_ref) {\n  var vault = _ref.vault,\n      reset = _ref.reset;\n\n  var _useAnalytics = useAnalytics('Payback', 'Sidebar'),\n      trackBtnClick = _useAnalytics.trackBtnClick;\n\n  var _useLanguage = useLanguage(),\n      lang = _useLanguage.lang;\n\n  var _useMaker = useMaker(),\n      maker = _useMaker.maker;\n\n  var balances = useWalletBalances();\n  var daiBalance = balances.USDFL;\n\n  var _useTokenAllowance = useTokenAllowance('USDFL'),\n      hasAllowance = _useTokenAllowance.hasAllowance,\n      hasSufficientAllowance = _useTokenAllowance.hasSufficientAllowance;\n\n  var _useProxy = useProxy(),\n      hasProxy = _useProxy.hasProxy;\n\n  var debtValue = vault.debtValue,\n      debtFloor = vault.debtFloor,\n      collateralAmount = vault.collateralAmount;\n  debtValue = debtValue.toBigNumber().decimalPlaces(2);\n  var symbol = collateralAmount === null || collateralAmount === void 0 ? void 0 : collateralAmount.symbol;\n  var vaultUnderDustLimit = debtValue.gt(0) && debtValue.lt(debtFloor); // Amount being repaid can't result in a remaining debt lower than the dust\n  // minimum unless the full amount is being repaid\n\n  var dustLimitValidation = function dustLimitValidation(input) {\n    return greaterThan(debtFloor, subtract(debtValue, input)) && equalTo(input, debtValue) !== true;\n  };\n\n  var _useValidatedInput = useValidatedInput('', {\n    maxFloat: Math.min(daiBalance, debtValue),\n    minFloat: 0,\n    isFloat: true,\n    custom: {\n      dustLimit: dustLimitValidation,\n      allowanceInvalid: function allowanceInvalid(value) {\n        return !hasSufficientAllowance(value);\n      }\n    }\n  }, {\n    maxFloat: function maxFloat(amount) {\n      return greaterThan(amount, daiBalance) ? lang.formatString(lang.action_sidebar.insufficient_balance, 'USDFL') : lang.action_sidebar.cannot_payback_more_than_owed;\n    },\n    dustLimit: function dustLimit() {\n      return vaultUnderDustLimit ? lang.cdp_create.dust_payback_below_limit : lang.formatString(lang.cdp_create.dust_max_payback, subtract(debtValue, debtFloor));\n    },\n    allowanceInvalid: function allowanceInvalid() {\n      return lang.formatString(lang.action_sidebar.invalid_allowance, 'USDFL');\n    }\n  }),\n      _useValidatedInput2 = _slicedToArray(_useValidatedInput, 4),\n      amount = _useValidatedInput2[0],\n      setAmount = _useValidatedInput2[1],\n      onAmountChange = _useValidatedInput2[2],\n      amountErrors = _useValidatedInput2[3];\n\n  var amountToPayback = amount || 0; // Don't enter more than the user's balance if there isn't enough to cover the debt.\n\n  var maxPaybackAmount = debtValue && daiBalance && minimum(debtValue, daiBalance);\n\n  var setMax = function setMax() {\n    return setAmount(maxPaybackAmount.toString());\n  };\n\n  var payback = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n      var cdpManager, owner, wipeAll;\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              cdpManager = maker.service('mcd:cdpManager');\n              _context.next = 3;\n              return cdpManager.getOwner(vault.id);\n\n            case 3:\n              owner = _context.sent;\n\n              if (owner) {\n                _context.next = 7;\n                break;\n              }\n\n              log(\"Unable to find owner of CDP #\".concat(vault.id));\n              return _context.abrupt(\"return\");\n\n            case 7:\n              wipeAll = debtValue.toString() === amount;\n              if (wipeAll) log('Calling wipeAll()');else log('Calling wipe()');\n              wipeAll ? cdpManager.wipeAll(vault.id, owner) : cdpManager.wipe(vault.id, USDFL(amount), owner);\n              reset();\n\n            case 11:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function payback() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var valid = amount && !amountErrors && hasProxy && hasAllowance;\n  var undercollateralized = debtValue.minus(amountToPayback).lt(0);\n  var collateralizationRatio = undercollateralized ? Infinity : vault.calculateCollateralizationRatio({\n    debtValue: USDFL(debtValue.minus(amountToPayback))\n  });\n  return /*#__PURE__*/React.createElement(Grid, {\n    gridRowGap: \"m\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 112,\n      columnNumber: 5\n    }\n  }, /*#__PURE__*/React.createElement(Grid, {\n    gridRowGap: \"s\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 113,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Text, {\n    style: {\n      fontSize: '20px',\n      color: getColor('whiteText')\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 114,\n      columnNumber: 9\n    }\n  }, lang.action_sidebar.payback_title), /*#__PURE__*/React.createElement(Text, {\n    style: {\n      fontSize: '16px',\n      color: getColor('greyText')\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 117,\n      columnNumber: 9\n    }\n  }, lang.action_sidebar.payback_description), /*#__PURE__*/React.createElement(\"div\", {\n    className: \"input_border\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 120,\n      columnNumber: 9\n    }\n  }, /*#__PURE__*/React.createElement(Input, {\n    style: {\n      color: getColor('whiteText')\n    },\n    type: \"number\",\n    value: amount,\n    min: \"0\",\n    onChange: onAmountChange,\n    placeholder: \"0.00 USDFL\",\n    failureMessage: amountErrors,\n    \"data-testid\": \"payback-input\",\n    after: /*#__PURE__*/React.createElement(SetMax, {\n      onClick: function onClick() {\n        setMax();\n        trackBtnClick('SetMax', {\n          maxAmount: maxPaybackAmount.toString(),\n          setMax: true\n        });\n      },\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 131,\n        columnNumber: 15\n      }\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 121,\n      columnNumber: 11\n    }\n  }))), /*#__PURE__*/React.createElement(ProxyAllowanceToggle, {\n    token: \"USDFL\",\n    trackBtnClick: trackBtnClick,\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 144,\n      columnNumber: 7\n    }\n  }), /*#__PURE__*/React.createElement(Grid, {\n    gridTemplateColumns: \"1fr 1fr\",\n    gridColumnGap: \"s\",\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 145,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Button, {\n    className: \"btn\",\n    disabled: !valid,\n    onClick: function onClick() {\n      trackBtnClick('Confirm', {\n        amount: amount,\n        fathom: {\n          id: \"\".concat(symbol, \"VaultPayback\"),\n          amount: amount\n        }\n      });\n      payback();\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 146,\n      columnNumber: 9\n    }\n  }, lang.actions.pay_back), /*#__PURE__*/React.createElement(Button, {\n    className: \"btn\",\n    variant: \"secondary-outline\",\n    onClick: function onClick() {\n      trackBtnClick('Cancel');\n      reset();\n    },\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 159,\n      columnNumber: 9\n    }\n  }, lang.cancel)), /*#__PURE__*/React.createElement(InfoContainer, {\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 170,\n      columnNumber: 7\n    }\n  }, /*#__PURE__*/React.createElement(Info, {\n    title: lang.action_sidebar.dai_balance,\n    body: \"\".concat(daiBalance && formatter(daiBalance, {\n      precision: short\n    }), \" USDFL\"),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 171,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(Info, {\n    title: lang.action_sidebar.dai_debt,\n    body: \"\".concat(formatter(debtValue, {\n      precision: short\n    }), \" USDFL\"),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 176,\n      columnNumber: 9\n    }\n  }), /*#__PURE__*/React.createElement(Info, {\n    title: lang.action_sidebar.new_collateralization_ratio,\n    body: formatCollateralizationRatio(collateralizationRatio),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 180,\n      columnNumber: 9\n    }\n  })));\n};\n\n__signature__(Payback, \"useAnalytics{{ trackBtnClick }}\\nuseLanguage{{ lang }}\\nuseMaker{{ maker }}\\nuseWalletBalances{balances}\\nuseTokenAllowance{{ hasAllowance, hasSufficientAllowance }}\\nuseProxy{{ hasProxy }}\\nuseValidatedInput{[amount, setAmount, onAmountChange, amountErrors]}\", function () {\n  return [useAnalytics, useLanguage, useMaker, useWalletBalances, useTokenAllowance, useProxy, useValidatedInput];\n});\n\nvar _default = Payback;\nexport default _default;\n;\n\n(function () {\n  var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;\n\n  if (!reactHotLoader) {\n    return;\n  }\n\n  reactHotLoader.register(short, \"short\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/components/Sidebars/Payback.js\");\n  reactHotLoader.register(log, \"log\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/components/Sidebars/Payback.js\");\n  reactHotLoader.register(Payback, \"Payback\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/components/Sidebars/Payback.js\");\n  reactHotLoader.register(_default, \"default\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/components/Sidebars/Payback.js\");\n})();\n\n;\n\n(function () {\n  var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;\n  leaveModule && leaveModule(module);\n})();","map":{"version":3,"sources":["/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/components/Sidebars/Payback.js"],"names":["React","USDFL","Text","Input","Grid","Button","debug","getColor","formatCollateralizationRatio","useMaker","useProxy","useTokenAllowance","useWalletBalances","useValidatedInput","useLanguage","useAnalytics","formatter","subtract","greaterThan","equalTo","minimum","Info","InfoContainer","ProxyAllowanceToggle","SetMax","decimalRules","short","log","Payback","vault","reset","trackBtnClick","lang","maker","balances","daiBalance","hasAllowance","hasSufficientAllowance","hasProxy","debtValue","debtFloor","collateralAmount","toBigNumber","decimalPlaces","symbol","vaultUnderDustLimit","gt","lt","dustLimitValidation","input","maxFloat","Math","min","minFloat","isFloat","custom","dustLimit","allowanceInvalid","value","amount","formatString","action_sidebar","insufficient_balance","cannot_payback_more_than_owed","cdp_create","dust_payback_below_limit","dust_max_payback","invalid_allowance","setAmount","onAmountChange","amountErrors","amountToPayback","maxPaybackAmount","setMax","toString","payback","cdpManager","service","getOwner","id","owner","wipeAll","wipe","valid","undercollateralized","minus","collateralizationRatio","Infinity","calculateCollateralizationRatio","fontSize","color","payback_title","payback_description","maxAmount","fathom","actions","pay_back","cancel","dai_balance","precision","dai_debt","new_collateralization_ratio"],"mappings":"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","sourcesContent":["import React from 'react';\nimport { USDFL } from '../../libs/dai-plugin-mcd/src/index.js';\nimport { Text, Input, Grid, Button } from '@makerdao/ui-components-core';\nimport debug from 'debug';\nimport { getColor } from '../../styles/theme';\n\nimport { formatCollateralizationRatio } from 'utils/ui';\n\nimport useMaker from 'hooks/useMaker';\nimport useProxy from 'hooks/useProxy';\nimport useTokenAllowance from 'hooks/useTokenAllowance';\nimport useWalletBalances from 'hooks/useWalletBalances';\nimport useValidatedInput from 'hooks/useValidatedInput';\nimport useLanguage from 'hooks/useLanguage';\nimport useAnalytics from 'hooks/useAnalytics';\nimport { formatter } from '../../utils/ui';\nimport { subtract, greaterThan, equalTo, minimum } from '../../utils/bignumber';\n\nimport Info from './shared/Info';\nimport InfoContainer from './shared/InfoContainer';\nimport ProxyAllowanceToggle from 'components/ProxyAllowanceToggle';\nimport SetMax from 'components/SetMax';\nimport { decimalRules } from '../../styles/constants';\n\nconst { short } = decimalRules;\n\nconst log = debug('maker:Sidebars/Payback');\n\nconst Payback = ({ vault, reset }) => {\n  const { trackBtnClick } = useAnalytics('Payback', 'Sidebar');\n  const { lang } = useLanguage();\n  const { maker } = useMaker();\n  const balances = useWalletBalances();\n  const daiBalance = balances.USDFL;\n\n  const { hasAllowance, hasSufficientAllowance } = useTokenAllowance('USDFL');\n  const { hasProxy } = useProxy();\n\n  let { debtValue, debtFloor, collateralAmount } = vault;\n  debtValue = debtValue.toBigNumber().decimalPlaces(2);\n  const symbol = collateralAmount?.symbol;\n  const vaultUnderDustLimit = debtValue.gt(0) && debtValue.lt(debtFloor);\n\n  // Amount being repaid can't result in a remaining debt lower than the dust\n  // minimum unless the full amount is being repaid\n  const dustLimitValidation = input =>\n    greaterThan(debtFloor, subtract(debtValue, input)) &&\n    equalTo(input, debtValue) !== true;\n\n  const [amount, setAmount, onAmountChange, amountErrors] = useValidatedInput(\n    '',\n    {\n      maxFloat: Math.min(daiBalance, debtValue),\n      minFloat: 0,\n      isFloat: true,\n      custom: {\n        dustLimit: dustLimitValidation,\n        allowanceInvalid: value => !hasSufficientAllowance(value)\n      }\n    },\n    {\n      maxFloat: amount => {\n        return greaterThan(amount, daiBalance)\n          ? lang.formatString(lang.action_sidebar.insufficient_balance, 'USDFL')\n          : lang.action_sidebar.cannot_payback_more_than_owed;\n      },\n      dustLimit: () =>\n        vaultUnderDustLimit\n          ? lang.cdp_create.dust_payback_below_limit\n          : lang.formatString(\n              lang.cdp_create.dust_max_payback,\n              subtract(debtValue, debtFloor)\n            ),\n      allowanceInvalid: () =>\n        lang.formatString(lang.action_sidebar.invalid_allowance, 'USDFL')\n    }\n  );\n\n  const amountToPayback = amount || 0;\n\n  // Don't enter more than the user's balance if there isn't enough to cover the debt.\n  const maxPaybackAmount =\n    debtValue && daiBalance && minimum(debtValue, daiBalance);\n  const setMax = () =>\n    setAmount(maxPaybackAmount.toString());\n\n  const payback = async () => {\n    const cdpManager = maker.service('mcd:cdpManager');\n    const owner = await cdpManager.getOwner(vault.id);\n    if (!owner) {\n      log(`Unable to find owner of CDP #${vault.id}`);\n      return;\n    }\n    const wipeAll = debtValue.toString() === amount;\n    if (wipeAll) log('Calling wipeAll()');\n    else log('Calling wipe()');\n    wipeAll\n      ? cdpManager.wipeAll(vault.id, owner)\n      : cdpManager.wipe(vault.id, USDFL(amount), owner);\n    reset();\n  };\n\n  const valid = amount && !amountErrors && hasProxy && hasAllowance;\n  const undercollateralized = debtValue.minus(amountToPayback).lt(0);\n\n  const collateralizationRatio = undercollateralized\n    ? Infinity\n    : vault.calculateCollateralizationRatio({\n        debtValue: USDFL(debtValue.minus(amountToPayback))\n      });\n  return (\n    <Grid gridRowGap=\"m\">\n      <Grid gridRowGap=\"s\">\n        <Text style={{ fontSize: '20px', color: getColor('whiteText') }}>\n          {lang.action_sidebar.payback_title}\n        </Text>\n        <Text style={{ fontSize: '16px', color: getColor('greyText') }}>\n          {lang.action_sidebar.payback_description}\n        </Text>\n        <div className=\"input_border\">\n          <Input\n            style={{ color: getColor('whiteText') }}\n            type=\"number\"\n            value={amount}\n            min=\"0\"\n            onChange={onAmountChange}\n            placeholder=\"0.00 USDFL\"\n            failureMessage={amountErrors}\n            data-testid=\"payback-input\"\n            after={\n              <SetMax\n                onClick={() => {\n                  setMax();\n                  trackBtnClick('SetMax', {\n                    maxAmount: maxPaybackAmount.toString(),\n                    setMax: true\n                  });\n                }}\n              />\n            }\n          />\n        </div>\n      </Grid>\n      <ProxyAllowanceToggle token=\"USDFL\" trackBtnClick={trackBtnClick} />\n      <Grid gridTemplateColumns=\"1fr 1fr\" gridColumnGap=\"s\">\n        <Button\n          className=\"btn\"\n          disabled={!valid}\n          onClick={() => {\n            trackBtnClick('Confirm', {\n              amount,\n              fathom: { id: `${symbol}VaultPayback`, amount }\n            });\n            payback();\n          }}\n        >\n          {lang.actions.pay_back}\n        </Button>\n        <Button\n          className=\"btn\"\n          variant=\"secondary-outline\"\n          onClick={() => {\n            trackBtnClick('Cancel');\n            reset();\n          }}\n        >\n          {lang.cancel}\n        </Button>\n      </Grid>\n      <InfoContainer>\n        <Info\n          title={lang.action_sidebar.dai_balance}\n          body={`${daiBalance &&\n            formatter(daiBalance, { precision: short })} USDFL`}\n        />\n        <Info\n          title={lang.action_sidebar.dai_debt}\n          body={`${formatter(debtValue, { precision: short })} USDFL`}\n        />\n        <Info\n          title={lang.action_sidebar.new_collateralization_ratio}\n          body={formatCollateralizationRatio(collateralizationRatio)}\n        />\n      </InfoContainer>\n    </Grid>\n  );\n};\nexport default Payback;\n"]},"metadata":{},"sourceType":"module"}
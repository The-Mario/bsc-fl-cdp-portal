{"ast":null,"code":"import _regeneratorRuntime from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass\";\nimport _inherits from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits\";\nimport _createSuper from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper\";\nimport _applyDecoratedDescriptor from \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/applyDecoratedDescriptor\";\n\nvar _class;\n\n(function () {\n  var enterModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.enterModule : undefined;\n  enterModule && enterModule(module);\n})();\n\nvar __signature__ = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default.signature : function (a) {\n  return a;\n};\n\nimport { PrivateService } from '@makerdao/services-core';\nimport BigNumber from 'bignumber.js';\nimport { UINT256_MAX } from '../utils/constants';\nimport tracksTransactions from '../utils/tracksTransactions';\nvar maxAllowance = BigNumber(UINT256_MAX).shiftedBy(-18);\nvar AllowanceService = (_class = /*#__PURE__*/function (_PrivateService) {\n  _inherits(AllowanceService, _PrivateService);\n\n  var _super = _createSuper(AllowanceService);\n\n  function AllowanceService() {\n    var _this;\n\n    var name = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'allowance';\n\n    _classCallCheck(this, AllowanceService);\n\n    _this = _super.call(this, name, ['token', 'event']);\n    _this._shouldMinimizeAllowance = false;\n    return _this;\n  }\n\n  _createClass(AllowanceService, [{\n    key: \"initialize\",\n    value: function initialize(settings) {\n      if (settings && settings.useMinimizeAllowancePolicy) {\n        this._shouldMinimizeAllowance = true;\n      }\n    }\n  }, {\n    key: \"requireAllowance\",\n    value: function () {\n      var _requireAllowance = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(tokenSymbol, receiverAddress, _ref) {\n        var _ref$estimate, estimate, promise, token, ownerAddress, allowance, tx, _tx;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _ref$estimate = _ref.estimate, estimate = _ref$estimate === void 0 ? maxAllowance : _ref$estimate, promise = _ref.promise;\n                token = this.get('token').getToken(tokenSymbol);\n                ownerAddress = this.get('token').get('web3').currentAddress();\n                _context.next = 5;\n                return token.allowance(ownerAddress, receiverAddress);\n\n              case 5:\n                allowance = _context.sent;\n\n                if (!(allowance.lt(maxAllowance.div(2)) && !this._shouldMinimizeAllowance)) {\n                  _context.next = 12;\n                  break;\n                }\n\n                _context.next = 9;\n                return token.approveUnlimited(receiverAddress, {\n                  promise: promise\n                });\n\n              case 9:\n                tx = _context.sent;\n                this.get('event').emit('allowance/APPROVE', {\n                  transaction: tx\n                });\n                return _context.abrupt(\"return\", tx);\n\n              case 12:\n                if (!(allowance.lt(estimate) && this._shouldMinimizeAllowance)) {\n                  _context.next = 17;\n                  break;\n                }\n\n                _context.next = 15;\n                return token.approve(receiverAddress, estimate, {\n                  promise: promise\n                });\n\n              case 15:\n                _tx = _context.sent;\n                this.get('event').emit('allowance/APPROVE', {\n                  transaction: _tx\n                });\n\n              case 17:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function requireAllowance(_x, _x2, _x3) {\n        return _requireAllowance.apply(this, arguments);\n      }\n\n      return requireAllowance;\n    }()\n  }, {\n    key: \"removeAllowance\",\n    value: function () {\n      var _removeAllowance = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(tokenSymbol, spenderAddress, _ref2) {\n        var promise, token, allowance;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                promise = _ref2.promise;\n                token = this.get('token').getToken(tokenSymbol);\n                _context2.next = 4;\n                return token.allowance(this.get('token').get('web3').currentAddress(), spenderAddress);\n\n              case 4:\n                allowance = _context2.sent;\n\n                if (!(parseInt(allowance) != 0)) {\n                  _context2.next = 7;\n                  break;\n                }\n\n                return _context2.abrupt(\"return\", token.approve(spenderAddress, '0', {\n                  promise: promise\n                }));\n\n              case 7:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function removeAllowance(_x4, _x5, _x6) {\n        return _removeAllowance.apply(this, arguments);\n      }\n\n      return removeAllowance;\n    }()\n  }, {\n    key: \"__reactstandin__regenerateByEval\",\n    // @ts-ignore\n    value: function __reactstandin__regenerateByEval(key, code) {\n      // @ts-ignore\n      this[key] = eval(code);\n    }\n  }]);\n\n  return AllowanceService;\n}(PrivateService), (_applyDecoratedDescriptor(_class.prototype, \"requireAllowance\", [tracksTransactions], Object.getOwnPropertyDescriptor(_class.prototype, \"requireAllowance\"), _class.prototype), _applyDecoratedDescriptor(_class.prototype, \"removeAllowance\", [tracksTransactions], Object.getOwnPropertyDescriptor(_class.prototype, \"removeAllowance\"), _class.prototype)), _class);\nexport { AllowanceService as default };\n;\n\n(function () {\n  var reactHotLoader = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.default : undefined;\n\n  if (!reactHotLoader) {\n    return;\n  }\n\n  reactHotLoader.register(maxAllowance, \"maxAllowance\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/libs/dai/src/eth/AllowanceService.js\");\n  reactHotLoader.register(AllowanceService, \"AllowanceService\", \"/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/libs/dai/src/eth/AllowanceService.js\");\n})();\n\n;\n\n(function () {\n  var leaveModule = typeof reactHotLoaderGlobal !== 'undefined' ? reactHotLoaderGlobal.leaveModule : undefined;\n  leaveModule && leaveModule(module);\n})();","map":{"version":3,"sources":["/Users/good/Documents/Good/GitHub/FL/fork/bsc-fl-cdp-portal/src/libs/dai/src/eth/AllowanceService.js"],"names":["PrivateService","BigNumber","UINT256_MAX","tracksTransactions","maxAllowance","shiftedBy","AllowanceService","name","_shouldMinimizeAllowance","settings","useMinimizeAllowancePolicy","tokenSymbol","receiverAddress","estimate","promise","token","get","getToken","ownerAddress","currentAddress","allowance","lt","div","approveUnlimited","tx","emit","transaction","approve","spenderAddress","parseInt"],"mappings":";;;;;;;;;;;;;;;;;;;AAAA,SAASA,cAAT,QAA+B,yBAA/B;AACA,OAAOC,SAAP,MAAsB,cAAtB;AACA,SAASC,WAAT,QAA4B,oBAA5B;AACA,OAAOC,kBAAP,MAA+B,6BAA/B;AAEA,IAAMC,YAAY,GAAGH,SAAS,CAACC,WAAD,CAAT,CAAuBG,SAAvB,CAAiC,CAAC,EAAlC,CAArB;IAEqBC,gB;;;;;AACnB,8BAAgC;AAAA;;AAAA,QAApBC,IAAoB,uEAAb,WAAa;;AAAA;;AAC9B,8BAAMA,IAAN,EAAY,CAAC,OAAD,EAAU,OAAV,CAAZ;AACA,UAAKC,wBAAL,GAAgC,KAAhC;AAF8B;AAG/B;;;;+BAEUC,Q,EAAU;AACnB,UAAIA,QAAQ,IAAIA,QAAQ,CAACC,0BAAzB,EAAqD;AACnD,aAAKF,wBAAL,GAAgC,IAAhC;AACD;AACF;;;;wGAICG,W,EACAC,e;;;;;;;qCACEC,Q,EAAAA,Q,8BAAWT,Y,kBAAcU,O,QAAAA,O;AAErBC,gBAAAA,K,GAAQ,KAAKC,GAAL,CAAS,OAAT,EAAkBC,QAAlB,CAA2BN,WAA3B,C;AACRO,gBAAAA,Y,GAAe,KAAKF,GAAL,CAAS,OAAT,EAClBA,GADkB,CACd,MADc,EAElBG,cAFkB,E;;uBAGGJ,KAAK,CAACK,SAAN,CAAgBF,YAAhB,EAA8BN,eAA9B,C;;;AAAlBQ,gBAAAA,S;;sBAEFA,SAAS,CAACC,EAAV,CAAajB,YAAY,CAACkB,GAAb,CAAiB,CAAjB,CAAb,KAAqC,CAAC,KAAKd,wB;;;;;;uBAC5BO,KAAK,CAACQ,gBAAN,CAAuBX,eAAvB,EAAwC;AAAEE,kBAAAA,OAAO,EAAPA;AAAF,iBAAxC,C;;;AAAXU,gBAAAA,E;AACN,qBAAKR,GAAL,CAAS,OAAT,EAAkBS,IAAlB,CAAuB,mBAAvB,EAA4C;AAC1CC,kBAAAA,WAAW,EAAEF;AAD6B,iBAA5C;iDAGOA,E;;;sBAGLJ,SAAS,CAACC,EAAV,CAAaR,QAAb,KAA0B,KAAKL,wB;;;;;;uBAChBO,KAAK,CAACY,OAAN,CAAcf,eAAd,EAA+BC,QAA/B,EAAyC;AAAEC,kBAAAA,OAAO,EAAPA;AAAF,iBAAzC,C;;;AAAXU,gBAAAA,G;AACN,qBAAKR,GAAL,CAAS,OAAT,EAAkBS,IAAlB,CAAuB,mBAAvB,EAA4C;AAC1CC,kBAAAA,WAAW,EAAEF;AAD6B,iBAA5C;;;;;;;;;;;;;;;;;;;wGAOkBb,W,EAAaiB,c;;;;;;AAAkBd,gBAAAA,O,SAAAA,O;AAC7CC,gBAAAA,K,GAAQ,KAAKC,GAAL,CAAS,OAAT,EAAkBC,QAAlB,CAA2BN,WAA3B,C;;uBACUI,KAAK,CAACK,SAAN,CACtB,KAAKJ,GAAL,CAAS,OAAT,EACGA,GADH,CACO,MADP,EAEGG,cAFH,EADsB,EAItBS,cAJsB,C;;;AAAlBR,gBAAAA,S;;sBAMFS,QAAQ,CAACT,SAAD,CAAR,IAAuB,C;;;;;kDAClBL,KAAK,CAACY,OAAN,CAAcC,cAAd,EAA8B,GAA9B,EAAmC;AAAEd,kBAAAA,OAAO,EAAPA;AAAF,iBAAnC,C;;;;;;;;;;;;;;;;;;;;;;;;;;EAlDiCd,c,qEAY3CG,kB,6JA4BAA,kB;SAxCkBG,gB;;;;;;;;;;0BAFfF,Y;0BAEeE,gB","sourcesContent":["import { PrivateService } from '@makerdao/services-core';\nimport BigNumber from 'bignumber.js';\nimport { UINT256_MAX } from '../utils/constants';\nimport tracksTransactions from '../utils/tracksTransactions';\n\nconst maxAllowance = BigNumber(UINT256_MAX).shiftedBy(-18);\n\nexport default class AllowanceService extends PrivateService {\n  constructor(name = 'allowance') {\n    super(name, ['token', 'event']);\n    this._shouldMinimizeAllowance = false;\n  }\n\n  initialize(settings) {\n    if (settings && settings.useMinimizeAllowancePolicy) {\n      this._shouldMinimizeAllowance = true;\n    }\n  }\n\n  @tracksTransactions\n  async requireAllowance(\n    tokenSymbol,\n    receiverAddress,\n    { estimate = maxAllowance, promise }\n  ) {\n    const token = this.get('token').getToken(tokenSymbol);\n    const ownerAddress = this.get('token')\n      .get('web3')\n      .currentAddress();\n    const allowance = await token.allowance(ownerAddress, receiverAddress);\n\n    if (allowance.lt(maxAllowance.div(2)) && !this._shouldMinimizeAllowance) {\n      const tx = await token.approveUnlimited(receiverAddress, { promise });\n      this.get('event').emit('allowance/APPROVE', {\n        transaction: tx\n      });\n      return tx;\n    }\n\n    if (allowance.lt(estimate) && this._shouldMinimizeAllowance) {\n      const tx = await token.approve(receiverAddress, estimate, { promise });\n      this.get('event').emit('allowance/APPROVE', {\n        transaction: tx\n      });\n    }\n  }\n\n  @tracksTransactions\n  async removeAllowance(tokenSymbol, spenderAddress, { promise }) {\n    const token = this.get('token').getToken(tokenSymbol);\n    const allowance = await token.allowance(\n      this.get('token')\n        .get('web3')\n        .currentAddress(),\n      spenderAddress\n    );\n    if (parseInt(allowance) != 0) {\n      return token.approve(spenderAddress, '0', { promise });\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}